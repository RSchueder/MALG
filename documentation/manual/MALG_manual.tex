\documentclass{deltares_manual}
 
\begin{document}

\section{Framework of the macroalgae module}

\subsection{General description}

Macroalgae, kelp, or seaweed, are macroscopic multicellular marine algae that cover a large range of taxonomic groups. They are of interest from an ecological point of view as they provide habitat for marine animals, and also from an economic point of view as a product that can be harvested while bio-remediating marine waters. There specifically is interest in the use of macroalgae as a bioremediator in integrated multitrophic aquaculture (IMTA) systems, where they can convert excess farm nutrients into biomass and value added products. 

The macroalgae module (MALG) in DELWAQ is designed to model the the dynamics of kelp \textit{Saccharina} and is based almost entirely on the model described in Broch \textit{et al.} (2011). Note that numerous changes have been made to the equations to allow for compatibility with DELWAQ's mass based systems, and also to allow for the inclusion of MALG in 3D models, whereby the size of the seaweed needs to be modelled in addition to the biomass. The primary motivation for this development is for application in assessment of IMTA systems. The general model organization will be described here, specifically the implementation in the DELWAQ library. For further details of the derivation of the model equations please refer to Broch \textit{et al.} (2011).

Macroalgae can be idealized as 4 distinct state variable components:
\begin{itemize}
\item MacroALgae Structural mass (MALS)
\item MacroALgae Nitrogen storage mass (MALN)
\item MacroALgae Phosphorous storage mass (MALP)
\item MacroALgae Carbon storage mass (MALC)
\end{itemize}
Collectively these components represent the entire macroalgae frond, where frond is the term used to describe the macro structure of the algae visible to the naked eye, including the foot (attachment organ). Each component exhibits its own growth dynamics and interacts with the surrounding water independently. 

For instance, the structural mass represents the part of the macroalgae that increases the area and length of the total front when it grows. It does not take nutrients from the water, does not photosynthesize, and loses mass when it decays, producing detritus. It grows by taking nutrients (N/P/C) from its storage, and is thus responsible for growth respiration. The structural mass has units of dry matter (DM) is analogous to the common notion of 'dry matter'. It represents the dry weight of the plant minus the weight of water, nutrient stores, and carbon stores.
 
The nitrogen and phosphorous storage uptake nutrients (NH4, NO3, PO4) from the ambient water and store them for the structural mass during growth periods. In this model it is assumed the phosphorous storage dynamics are analagous to the nitrogen, but in reality the behaviour of phosphorous storage is not well known.

The carbon storage is the part of the plant responsible for photosynthesizing, producing exudate, and maintenence respiration. It produces carbon by taking up inorganic carbon and producing oxygen via photosynthesis. It provides carbon to the structural mass during growth periods. 

It is assumed that there is constant relationship between volume and area of a macroalgae frond. This means that the density of the macroalgae does not change, even if the ratio of structural mass to stored material changes. Additionally, the C:N and C:P ratios of each component are fixed, but because the ratio of stored mass to structural mass changes, the C:N and C:P ratios of the entire frond changes in due to changes in ambient conditions.

\subsection{Distribution of macroalgae biomass in the water column}
\begin{flushright}
	\textsc{process: MALDIS}
\end{flushright}
The physiological equations described in Broch\textit{et al.,} (2011) do not mention any physical description of the seaweed fronds in space aside from their area. The application of Broch in DELWAQ requires knowledge of the mass per m$^{2}$ and the vertical space occupied by the frond. Thus the algorithms for distributing the frond mass in space have been developed independently of the physiological formulations in Broch. 

A simple approach is taken, whereby fronds (typically) only grow in length and retain a constant length:area ratio. This is typically the case because a frond may reach the end of the water column while it still has the capcity to grow, in which case only the area and not the length will increase. The case for a single frond per computational cell is simple. However, the code must be able to deal with any seeding density, which cannot be uniquely defined by the mass per m$^{2}$ alone. For example, consider two cases whereby there exists 40g of dry matter per m$^{2}$. In the first example there are 4 fronds in a 1 m$^{2}$ square. They each weigh 10 g, have a combined area of 0.24 m$^{2}$ and are each 0.2 m long. In a second example, consider a single frond in a 1 m$^{2}$ square. It weighs 40 g, has an area of 0.24 m$^{2}$, and is 0.8 m long. In a 3D model with grid cells that are \textless 0.8 m thick, the nutrient uptake will take place in different cells in each of the two cases even though the mass per m$^{2}$ is identical in DELWAQ. To avoid this ambiguity the user must prescribe a set of parameters to describe the spatial characteristics of the culture. These are as follows:

\begin{itemize}
\item $FootDepth$ The depth below the water surface that the foot of the frond is attached. The frond begins growing from the segment that intersects this depth, and the segment can change with a variable water level as it is assigned each time step.
\item $LmaxMAL$ The maximum length of the frond measured in the z axis from the foot to the tip of the frond.
\item $SwGroMAL$ Switch for an upwards (\textgreater 0) or downwards (\textless 0) growing frond.
\item $LinDenMal$ The linear density of the culture. This describes the amount of mass it takes a m$^{2}$ of culture to grow 1 m. Four small fronds require more mass to increase their collective length by 1 m compared to a single long frond.
\item $ArDenMal$ The area density of the culture. This is the ratio between surface area and dry weight.
\end{itemize}

Based on these parameterizations the culture can be completely schemetized in 3 dimensions. The process begins by first calculating the length and the area of the culture in this column of segments:

\[LenMAL = MALS/ LinDenMAL\] 
\[AreMAL = MALS * Surf / ArDenMAL\] 

Where:\\
\begin{tabular}{ll}
$LenMAL$ & Length of frond in the column (m)\\
$Surf$ & Surface area of the bottom segment (m$^{2}$)\\
$MALS$ & structural mass (gDM m$^{-2}$)\\
$LinDenMAL$ & The linear density of the culture (g m$^{-3}$)\\
$ArDenMAL$ & The area density of the culture (g m$^{-2}$)\\
\end{tabular}

This length is then used to check which segments the frond biomass should be present in, and which fraction of the frond exists in each segment. This fraction is sent to each segment for all other computations involving biomass. The calculation of this depends firstly on whether the frond grows upwards or downwards.
\[IF SwGroDir < 0: Zm = LenMAL + FootDepth\]
\[IF SwGroDir < 0: Zm = FootDepth - LenMAL\]

Where:\\
\begin{tabular}{ll}
$Zm$ & Distance from water surface to tip of frond (positive down) (m)\\
$Z1$ & Distance from water surface to top of segment (positive down) (m)\\
$Z2$ & Distance from water surface to bottom of segment (positive down) (m)\\
\end{tabular}

The segment top depth $Z1$ and segment bottom depth $Z2$ are then checked against $Zm$ to see if the frond resides entirely within, entirely outside, or partially within the segment. The fraction of the biomass allocated to the current segment is then the ratio of the segment depth to $LenMAL$ in the column for segments in which the frond completely resides, or the ratio of the difference between $Zm$ and either $Z1$ or $Z2$ to $LenMAL$ for segments in which the tip or foot of the frond is found.

\subsection{Flux of Macroalgae structural biomass}
\begin{flushright}
\textsc{process: FLMALS}
\end{flushright}

The structural component of the macroalgae is the dry material that gives shape and structure to the macroalgae frond. As it grows it increases the length and area of the entire frond. Growth of other components of the frond do not have any effect on the frond length, volume, density, or surface area. 

The net growth of the structural mass is the resulting rate of structural biomass production and frond erosion (considered to be analagous to mortality used in other DELWAQ processes). This balance can be defined by the following function:

\[dGrowMALS =MALS \times (\mu - \phi)\]

The growth $\mu$ rate of MALS is dependent firstly on the nutrient (N, P, and C) stores available. Its growth rate is defined as follows:

\[\mu = f_{density} f_{photoperiod} f_{temperature}\times min\big\{1-\frac{N_{min}}{MALN},1-\frac{P_{min}}{MALP},1-\frac{C_{min}}{MALC}\big\}\]

Where:\\
\begin{tabular}{ll}
$\mu$  & specific growth rate of macroalgae sturctural mass (d$^{-1}$) \\
$\phi$ & mortality/erosion rate (d$^{-1}$) \\
$f_{density}$ & biomass density limitation function (-)\\
$f_{photoperiod}$ & photoperiod limitation function (-)\\
$f_{temperature}$ & temperature limitation function (-)\\
$N_{min}$ & minimum N storage (gN gDM$^{-1}$)\\
$MALN$ & nitrogen storage (gN/m$^2$)\\
$P_{min}$ & minimum phosphorous storage (gP gDM$^{-1}$)\\
$MALP$ & phosphorous storage (gP/m$^2$)\\
$C_{min}$ & minimum carbon storage (gC gDM$^{-1}$)\\
$MALC$ & carbon storage (gC/m$^2$)\\
\end{tabular}

Note that in the code the storage terms are temporarily converted to g/gDM using $MALS$ to comply with the formulations outlined in Broch \textit{et al.} (2011). The storage state variable terms are g m$^{-2}$ as per all non-transportable DELWAQ substances, and this is reflected in the fluxes, which are back calculated to g m$^{-2}d^{-1}$. As the substances are non transportable they reside in the bottom segment. However, depending on the user defined variables, there is not necessarily the influence of mass in the bottom segment, such as in the case where the algae grow from the water surface downward. This is discussed in MALDIS.

The growth rate of the structural mass is dependent on a density limitation, a photoperiod limitation, and a temperature limitation. These limitations differ from conventional DELWAQ limitations for algae growth in that they do not range strictly between 0 and 1. Instead Broch has tuned them such that their product is equal to the maximum growth rate when at optimal conditions. The density limitation represents the ability of the frond to only grow so big, and the bigger it gets the lower its growth rate will become. The photoperiod limitation is similar to the daylength limitation used in BLOOM and DYNAMO, but instead considers the \textit{change} in daylength compared to the previous day instead of the actual current daylength. This is due to the fact that \textit{Saccharina} is a seasonal anticipator and will grow and store nutrients in accordance with the change in the season as determined by how much longer or shorter the days become. The temperature limitation is a simple piece wise function that identifies an optimal growth between temperatures 10-15$^0$C, no growth above 19$^0$C, and linear growth increasing betwen -1.8 and 10$^0$C.  The limitation functions are formulated as follows:

\[f_{density} = m_1 exp\big\{-(\frac{MALS}{MALS_0})^2 \big\}+m_2\]
\[f_{photoperiod} = a_1 (1+sin(\tau (n) | \tau (n)| ^{\frac{1}{2}})) + a_2\]

where $\tau$ is a function describing the normalized difference in day length between current day and previous day.

\[f_{temperature} =  
\left 
.\begin{tabular}{cc}
$ 0.08T + 0.2 $    & $-1.8 \textless 10$ \\
$  1 $             & $10 \leq T \leq 15$ \\
$19/4 - T/4$       & $15 \leq T \leq 19$ \\ 
$0$                & $T \textgreater 19$ \\
\end{tabular}
\right 
.\]

Where:\\
\begin{tabular}{ll}
$m_1$    & mortality parameter 1 (-)\\
$m_2$    & mortality parameter 1 (-)\\
$MALS_0$ & critical biomass area (m$^2$)\\
$a_1$    & photoperiod parameter 1 (-)\\
$a_2$    & photoperiod parameter 2 (-)\\
\end{tabular}

The specific mortality rate $mrt$ of the structural biomass is dependent on the total area of the frond in relation to a critical large area and the erosion parameter. The formulation is as follows:
\[\phi = \frac{10^{-6}exp(\epsilon\times MALS)}{1+10^{-6}exp((\epsilon\times MALS)-1)}\]

Where:\\
\begin{tabular}{ll}
$\epsilon$ & erosion parameter (m$^{-2}$)\\
\end{tabular}

This process occurs over all segments which have a biomass fraction \textgreater 0. This is in spite of the fact that the biomass administratively resides in the bottom segment. During each time step each segment essentially receives 'ghost' structural and storage mass depending on the biomass allocated to it in MALDIS. The local fluxes are calculated using this mass and the local ambient environment. The fluxes are then locally applied to ambient dissolved parameters, but not algae parameters. Instead the fluxes of algae parameters are communicated to the bottom segment in a cumulative way, whereby the local fluxes of all segments that share the same bottom segment are summed to compute the net total change in MALS, MALN, MALP, and MALC resulting from the net growth in the column. Once the bottom segment is reached this gives the new mass of each in the bottom segment and the plant will  become longer or shorter in the next time step to reflect this new state. The consequence of this method is that the local per segment ghost reserves adopt the reserve ratio of the whole column. Another way to say this is that the entire segment has a fixed structural to storage ratio, as in no segment can have a beefier part of the plant than the other.

\subsection{Flux of Macroalgae nutrient storage}
\begin{flushright}
\textsc{process: FLMALN}
\end{flushright}

The nutrient storage component(s) of the macroalgae are those that the structural mass grows upon. The storage is also responsible for taking up nutrients from the ambient water. They consist of a nitrogen (MALN) and a phosphorous (MALP) storage component, which are both dealt with in the same nutrient storage subroutine. Note that Broch \textit{et al.} (2011) does not include a phosphorous component to the nutrient storage, but it is included in this model for flexibility should new information about phosphorous storage become available.

The change in a nutrient storage mass is given by the following equations:

\[dUptMALN = J_N - mu(K_c \times k_N \times MALS + MALN)\]
\[dUptMALP = J_P - mu(k_C \times k_P \times MALS + MALP)\]

This represents the balance between uptake $J$ and utilization for growth of the frond's structural mass. The uptake is dependent on flow velocity, the amount of stores compared to the minimum and maximum possible, and the ambient nutrient concentration. The formulation for both nitrogen and phosphorus is described as follows:

\[J_N = f_{velocity}J_{Nmax}(\frac{NO_3^-}{K_{sn}+NO_3^-})(\frac{MALN_{max}-MALN}{MALN_{max}-MALN_{min}})\]
\[J_P = f_{velocity}J_{Pmax}(\frac{PO_4^{3-}}{K_{sp}+PO_4^{3-}})(\frac{MALP_{max}-MALP}{MALP_{max}-MALP_{min}})\]

Where the first term pertains to the uptake of nutrients and the second term to the utilization of stores by the structural mass. Note how the nutrient requirement is dependent on those required to add more structural mass and more storage mass. This is because the total storage in the frond will increase as the frond grows, but the ratio of storage to structural mass is maintained for the growth timestep. The velocity function $f_{velocity}$ is formulated as:
\[f_{velocity} = 1-exp(-\frac{U}{U_{0.65}})\]
and where:\\
\begin{tabular}{ll}
$k_C$        & carbon:dry matter ratio in structural mass (gC gDM$^{-1}$)\\
$k_N$        & nitrogen:carbon ratio in structural mass (gN gC$^{-1}$)\\
$k_P$        & phosphorous:carbon ratio in structural mass (gN gC$^{-1}$)\\
$J_{Nmax}$   & maximum uptake rate nitrogen (gN m$^{-2}$d$^{-1}$)\\
$K_{sn}$     & half saturation for inorganic nitrogen uptake\\
$NO_3^-$     & ambient nitrate concentration (gN m$^{-3}$)\\
$MALN_{max}$ & maximum nitrogen storage (gN gDM$^{-1}$)\\
$MALN_{min}$ & minimum nitrogen storage (gN gDM$^{-1}$)\\
$J_{Pmax}$   & maximum uptake rate nitrogen gP m$^{-2}$d$^{-1}$)\\
$K_{sp}$     & half saturation for inorganic nitrogen uptake (gP m$^{-3}$)\\
$PO_4^{3-}$  & ambient phosphate concentration (gP m$^{-3}$)\\
$MALP_{max}$ & maximum phosphorous storage (gP gDM$^{-1}$)\\
$MALN_{min}$ & minimum phosphorous storage (gP gDM$^{-1}$)\\
$U$          & water velocity (m s$^{-1}$)\\
$U_{0.65}$   & water velocity at which uptake rate is 65 of maximum (m s$^{-1}$)\\
\end{tabular}

The uptake of nutrients is dependent on the ambient concentration according to Michaelis-Menten kinetics. It is dependent on velocity such that high velocities make it easier for the frond to uptake the nutrients. This is related to an improved mass transfer coefficient. At sufficiently high ambient concentrations and water velocities the uptake rate is $J_{max}$.

\subsection{Flux of Macroalgae carbon storage}
\begin{flushright}
\textsc{process: FLMALC}
\end{flushright}

The carbon storage component(s) of the macroalgae are those that the structural mass grows upon. The carbon storage (MALC)is also responsible for photosynthesis, maintenance respiration and exudation. The change in a carbon storage mass is given by the following equations:

\[dUptMALC = P(1-E)-R - \mu(k_C \times MALS + MALC)\]

Where:
\begin{tabular}{ll}
$P$ & Gross photosynthetic rate (gCm$^{-3}$ d$^{-1}$)\\
$E$ & Fraction exudation (-)\\\
$R$ & Maintenance respiration rate (gCm$^{-3}$ d$^{-1}$)\\
\end{tabular}

Where the first term relates to the net of production, respiration and exudation, and the second term pertains to the utilization of carbon stores by the structural mass.

The growth production rate is given by the following equation:
\[P = P_s(1-exp(-\frac{\alpha \times I}{P_s}))exp(-\frac{\beta \times I}{P_s})\]
\[P_s = \frac{\alpha \times I_{sat}}{ln(1+\frac{\alpha}{\beta})}\]
\[P_{max} = (\frac{\alpha \times I_{sat}}{ln(1+\frac{\alpha}{\beta}})(\frac{\alpha}{\alpha+\beta})(\frac{\beta}{\alpha+\beta})^{\frac{\beta}{\alpha}}\]
\[P_{max} = \frac{P_1exp(\frac{T_{AP}}{T_{P1}})}{1+exp(\frac{T_{APL}}{T} - \frac{T_{APL}}{T_{PL}})+exp(\frac{T_{APH}}{T_{PH}}-\frac{T_{APH}}{T})}\]

Where:\\
\begin{tabular}{ll}
$P_s$ & Saturation photosynthetic rate (gC m$^{-3}$ d$^{-1}$)\\
$I$ & Incident radiation (W m$^{-2}$)\\
$I_{sat}$ & Saturation radiation (W m$^{-2}$)\\
$\alpha$ & Photosynthetic efficiency (gC d$^{-1}$W$^{-1}$) \\
$\beta$ & Photosynthetic light inhibition (gC d$^{-1}$W$^{-1}$) \\
$P_1$ & Reference photosynthetic rate at T$_1$\\
$P_2$ & Reference photosynthetic rate at T$_2$\\
$T$ & Water temperature (K)\\
$T_{P1}$ & temp for reference photosynthetic rate 1\\
$T_{P2}$ & temp for reference photosynthetic rate 2	\\
$T_{AP}$ & Arrhenius temperature for photosynthesis               (degK)\\
$T_{APH}$ & Arrhenius temp for photosynthesis high end             (degK)\\
$T_{APL}$ & Arrhenius temp for photosynthesis low end             (degK)\\
\end{tabular}

The equations describe a photo inhibitory effect for $I\textgreater I_{sat}$ in addition to a temperature growth inhibition effect for $Temp \textgreater T_{P2}$. The later describes an inability of \textit{Saccharina} to photosynthesize in warm waters. The structural mass is unable to grow above $Temp \textgreater 19^{0}$ This is something that has been fixed for the species as the user cannot felxibly change this unless the code is edited. Although the structural mass cannot grow, photosyntehtic production can still occur in the range $T_{P1}:T_{P2}$. To adapt the model to tropical species or species that have a different optimal temperature photosynthesis range, these parameters have to be edited in addition to the code for the piece-wise temperature growth function for $MALS$.

The maximum production rate $P_{max}$ and the saturation production rate $P_{s}$ are both dependent on temperature. $P_{s}$ is non-linear in the photoinhibition parameter $\beta$, and so the root $\beta$ is found using Newton's method in Broch. This involves solving for $\beta$ such that $P_{max}$ equals the $P_{max}$ obtained from the temperature relationship at the current temperature. Newton's method is not used in the DELWAQ code and instead $\beta$ is pre-calculated for all temperatures in the photosynthetic range 1$^{0}$C to 25$^{0}$C at an interval of 0.1$^{0}$C. This is hard coded into the FLMALC subroutine and constitutes a linear approximation of $\beta$. Due to this the model should only be used for temperature ranges $1^{0}C \textless T \textless 25^{0}C$. Currently:
\begin{itemize}
	\item $\beta \textless 1 ^{0}C = \beta(1 ^{0}C)$ and $\beta > 25 ^{0}C = \beta(25 ^{0}C)$. 
\end{itemize} 

\end{document}